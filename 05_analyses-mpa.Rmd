---
title: "Analyses - MPA by country"
author : "Nina Prasil & Jeremy Wicquart"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: "cosmo"
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 4
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.align = "center")

```

# Import functions, packages and data
- MPA zones implemented in the 30 countries studied
- Data filtration : * Were retained only protected areas fitting the "is MAP" definition (as defined by MPAtlas) 
* Are taken into account only MPA zones that are considered implemented (as defined by MPAtlas)

```{r base}

source("functions/graphical_par.R")
source("functions/theme_map.R")


# 2. Required packages ----

library(tidyverse) # Core tidyverse packages
library(extrafont) # Font use
library(readxl) # To read excel files
library(sf) # To plot maps

# 3. Load data ----
# 3.1. MPAs from MPAtlas

data_mpa <- read_sf("./../data/02_mpa/mpatlas_20201223_clean/mpatlas_20201223_clean.shp") %>% 
  # Select top 30
  filter(sovereign %in% c("AUS", "IDN", "PHL", "FRA", "PNG", "USA", "FJI", "SLB", "SAU", "MDV",
                          "CUB", "FSM", "BHS", "MDG", "MHL", "IND", "MYS", "EGY", "KIR", "TZA",
                          "MOZ", "SDN", "ERI", "JPN", "SYC", "BLZ", "GBR", "VUT", "TON", "MEX")) %>% 
  # Homogenize countries names
  rename(SOVEREIGN1 = sovereign) %>% 
  filter(is_mpa == 1) %>% 
  filter(implemente == 1) %>% 
  mutate(SOVEREIGN1 = str_replace_all(SOVEREIGN1, 
                                      c("AUS" = "Australia",
                                        "BHS" = "Bahamas", 
                                        "BLZ" = "Belize",
                                        "CUB" = "Cuba", 
                                        "EGY" = "Egypt", 
                                        "ERI" = "Eritrea", 
                                        "FJI" = "Fiji", 
                                        "FRA" = "France", 
                                        "FSM" = "Micronesia",
                                        "GBR" = "United Kingdom",
                                        "IDN" = "Indonesia", 
                                        "IND" = "India", 
                                        "JPN" = "Japan", 
                                        "KIR" = "Kiribati",
                                        "MDG" = "Madagascar", 
                                        "MDV" = "Maldives", 
                                        "MEX" = "Mexico",
                                        "MHL" = "Marshall Islands",
                                        "MOZ" = "Mozambique", 
                                        "MYS" = "Malaysia",
                                        "PHL" = "Philippines", 
                                        "PNG" = "Papua New Guinea",
                                        "SAU" = "Saudi Arabia",
                                        "SDN" = "Sudan", 
                                        "SLB" = "Solomon Islands",
                                        "SYC" = "Seychelles",
                                        "TON" = "Tonga",
                                        "TZA" = "Tanzania",
                                        "USA" = "United States",
                                        "VUT" = "Vanuatu")))


# 3.2. Transformed data from WRI - Reefs merged with EEZ

load(file = "./../data/reefs.eez.RData")


data_reefs <- reefs.eez %>%
  # Re-assign TERRITORY1 depending on geopolitical issues
  mutate(SOVEREIGN1 = case_when(TERRITORY1 == "Glorioso Islands" ~ "France",
                                TERRITORY1 == "Chagos Archipelago" ~ "United Kingdom",
                                TRUE ~ SOVEREIGN1)) %>% 
  # Convert to sf
  st_as_sf() 



# 3.2 Coral distribution - CRS in meters

coral_distribution <- read.csv("./../data/01_maps/02-clean_coral-distribution-reef-at-risk-data.csv") %>% 
  st_as_sf(., coords = c("long", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")

```

# Nb MPA zones with coral reefs

```{r}

# 1. Number of MPA zones  ----

data_mpa_top30 <- data_mpa %>% 
  group_by(SOVEREIGN1) %>% 
  st_drop_geometry() %>% 
  summarise(nb_mpa = n()) %>% 
  ungroup()



# 2. Extract all the MPA zones that contain coral reefs for the top 30 ----
# Does not take into account the protection level

mpa_w_reef <- data_mpa %>% 
  #spatial join btw coral distrib and the location of the MPAs
  st_join(coral_distribution, .,  left = FALSE) %>% 
  st_drop_geometry() %>% 
  #retain only one line per MPA
  distinct(mpa_id, .keep_all = T) %>% 
  group_by(SOVEREIGN1) %>% 
  summarise(nb_mpa_w_cr = n()) %>% 
  ungroup() %>% 
  arrange(SOVEREIGN1) %>% 
  left_join(data_mpa_top30, .)




```

# Surface MPA

```{r}

# 1. Calculate MPA area

mpa_area <- list()

for (i in unique(data_mpa$SOVEREIGN1)) {
  
  data_mpa_i <- data_mpa %>% 
    filter(SOVEREIGN1 == i) 
  
  mpa_comb_i <- st_union(st_combine(data_mpa_i), by_feature = T)
   
  mpa_area_i <- st_area(mpa_comb_i) 
  
  units(mpa_area_i) <- "km^2"
  
  mpa_area[[i]] = mpa_area_i
  
}



# 2. Clean table with all MPA related information

mpa_table <- as.data.frame(mpa_area, row.names = T) %>% 
  
  pivot_longer(., "Australia":"Vanuatu", names_to = "SOVEREIGN1", values_to = "mpa_area_km2") %>% 
  mutate(SOVEREIGN1 = str_replace_all(SOVEREIGN1, 
                                      c("Marshall.Islands" = "Marshall Islands",
                                        "Papua.New.Guinea" = "Papua New Guinea",
                                        "Saudia.Arabia" = "Saudi Arabia",
                                        "Solomon.Islands" = "Solomon Islands",
                                        "United.Kingdom" = "United Kingdom",
                                        "United.States" = "United States"))) %>% 
  arrange(SOVEREIGN1) %>% 
  left_join(mpa_w_reef, .)


# 3. Save table 

write_csv2(mpa_table, "../figs/02_mpa-with-reef.csv")


```


# Spatial overlap global coral reefs with MPA polygon 

```{r}

top_30 <- unique(data_mpa$SOVEREIGN1)

# 1. Dissolve all MPA zones in one polygon per country

mpa_tot <- list()

for (i in top_30) {
  
  data_mpa_i <- data_mpa %>% 
    filter(SOVEREIGN1 == i) 
    
  mpa_poly_i <- st_as_sf(st_union(st_combine(data_mpa_i), by_feature = T))

  mpa_tot[[i]] = mpa_poly_i
  
}


# 2. Clean table with all MPA related information

mpa_table <- as.data.frame(mpa_tot, row.names = T) %>% 
  
  pivot_longer(., "Australia":"Vanuatu", names_to = "SOVEREIGN1", values_to = "geometry") %>% 
  mutate(SOVEREIGN1 = str_replace_all(SOVEREIGN1, 
                                      c("Marshall.Islands" = "Marshall Islands",
                                        "Papua.New.Guinea" = "Papua New Guinea",
                                        "Saudia.Arabia" = "Saudi Arabia",
                                        "Solomon.Islands" = "Solomon Islands",
                                        "United.Kingdom" = "United Kingdom",
                                        "United.States" = "United States"))) %>% 
  arrange(SOVEREIGN1) 





# 3. Export to RData

save(mpa_tot, 
     file = "./../data/00_filtered/00-data_mpa_merged.RData")
    

# 2. Clean table with all MPA related information

mpa_table <- as.data.frame(mpa_tot, row.names = T) %>% 
  
  pivot_longer(., "Australia":"Vanuatu", names_to = "SOVEREIGN1", values_to = "geometry") %>% 
  mutate(SOVEREIGN1 = str_replace_all(SOVEREIGN1, 
                                      c("Marshall.Islands" = "Marshall Islands",
                                        "Papua.New.Guinea" = "Papua New Guinea",
                                        "Saudia.Arabia" = "Saudi Arabia",
                                        "Solomon.Islands" = "Solomon Islands",
                                        "United.Kingdom" = "United Kingdom",
                                        "United.States" = "United States"))) %>% 
  arrange(SOVEREIGN1) %>% 
  left_join(mpa_w_reef, .)


# 3. Save table 

write_csv2(mpa_table, "../figs/02_mpa-with-reef.csv")

################################# TEST
country_test <- data_mpa %>% filter(SOVEREIGN1 == "Egypt")

mpa_comb <- st_union(st_combine(country_test), by_feature = T) %>% 
  st_as_sf()

protected_reef <- reefs.eez %>% 
  st_transform(., crs = 4326) %>% 
  #mutate(SOVEREIGN1 = case_when(TERRITORY1 == "Glorioso Islands" ~ "France",
   #                             TERRITORY1 == "Chagos Archipelago" ~ "United Kingdom",
    #                            TRUE ~ SOVEREIGN1)) %>% 
  filter(SOVEREIGN1 == "Egypt") %>% 
  # Convert to sf
  st_as_sf() %>% 
  st_intersection(., mpa_comb)
  #st_join(., mpa_comb, left = FALSE, join = st_intersects)
  
reef_mpa_area_tot <- protected_reef %>% 
  mutate(reef_area = as.numeric(st_area(protected_reef)/1000000)) %>% 
  st_drop_geometry() %>% 
  summarise(total_reef_mpa = sum(reef_area))  
  



ggplot() +
  geom_sf(data = mpa_comb) +
  geom_sf(data = protected_reef)


###################################



  
```




```{r}

# Reproducibility

```{r reprod}

# 1. Reproducibility ----

sessionInfo()

```

---
Nina PRASIL & Jeremy WICQUART | `r format(Sys.time())`