---
title: "Analyses - Maps"
author : "Nina Prasil & Jeremy Wicquart"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: "cosmo"
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 4
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.align = "center")

```

# 1. Import functions, packages and data

```{r base}

# 1. Source functions ----

source("functions/graphical_par.R")
source("functions/theme_graph.R")

# 2. Required packages ----

library(tidyverse) # Core tidyverse packages
library(sf) # To plot maps
library(formattable) # For interactive html tables
library(DT) # For interactive html tables

# 3. Set default ggplot theme ----

theme_set(theme_graph())

# 4. Import data ----

# 4.2 Data benthos top 30 (raw) --

load("./../data/00_filtered/00-data_benthos-top_30.RData")

```

# Table reef area by country

```{r}

# 1. Load data ----

load(file = "./../data/reefs.eez.Rdata")

# 2. Transform to an sf object ----

data_reefs <- reefs.eez %>% 
  st_as_sf()

# 3. Calculate the reef area by country ----

data_reefs <- data_reefs %>% 
  # Calculate the reef area and transform it from m2 to km2
  mutate(reef_area = as.numeric(st_area(.))/1000000) %>%
  # Make the sum of area by country
  st_drop_geometry() %>% 
  group_by(SOVEREIGN1) %>% 
  summarise(total_area_abs = sum(reef_area)) %>% 
  ungroup() %>% 
  # Sort rows from higher reef area to lower
  arrange(-total_area_abs) %>% 
  # Calculate the relative contribution
  mutate(total_area_rel = total_area_abs*100/sum(total_area_abs),
         pos = row_number()) %>% 
  # Misc. modifications for formattable
  select(pos, SOVEREIGN1, total_area_abs, total_area_rel) %>% 
  mutate(total_area_abs = round(as.numeric(total_area_abs), 3),
         total_area_rel = round(as.numeric(total_area_rel), 3))

# 4. Make the table ----

data_reefs %>% 
  formattable(.) %>% 
  as.datatable(., rownames = FALSE, colnames = c("N°", "Country", "Area (km²)", "Relative (%)"))

```

# Distribution of years

```{r}

# 1. Modify the data ----

data_years <- data_benthos %>% 
  mutate(Longitude = st_coordinates(.)[,"X"],
         Latitude = st_coordinates(.)[,"Y"]) %>% 
  st_drop_geometry(.) %>% 
  select(Latitude, Longitude, Year, SOVEREIGN1) %>% 
  distinct(.) %>% 
  group_by(Year, SOVEREIGN1) %>% 
  count() %>% 
  group_by(SOVEREIGN1) %>% 
  mutate(Total = sum(n),
         freq = (n/sum(n))*100)

ggplot(data_years, aes(x = Year, y = freq)) +
    geom_histogram(stat = "identity", color = col_color_graph, fill = col_fill_graph) +
    lims(x = c(1970, 2020)) +
    labs(x = "Year", y = "Percentage of sites") +
  facet_wrap(~SOVEREIGN1)


for (i in unique(data_years$SOVEREIGN1)) {
  
  data_years_i <- data_years %>% 
    filter(SOVEREIGN1 == i)
  
  plot_i <- ggplot(data_years_i, aes(x = Year, y = freq)) +
    geom_histogram(stat = "identity", color = col_color_graph, fill = col_fill_graph) +
    lims(x = c(1970, 2020)) +
    labs(x = "Year", y = "Percentage of sites")
  
  ggsave(plot_i, filename = paste0("../figs/02_graph-transects-by-year_", tolower(as.character(i)), ".png"))

}

```

# Reproducibility

```{r reprod}

# 1. Reproducibility ----

sessionInfo()

```

---
Nina PRASIL & Jeremy WICQUART | `r format(Sys.time())`