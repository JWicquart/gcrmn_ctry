---
title: "Analyses - Maps"
author : "Nina Prasil & Jeremy Wicquart"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: "cosmo"
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 4
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.align = "center")

```

# Import functions, packages and data

```{r base}

# 1. Source functions ----

source("functions/graphical_par.R")
source("functions/theme_graph.R")

# 2. Required packages ----

library(tidyverse) # Core tidyverse packages
library(sf) # To plot maps
library(formattable) # For interactive html tables
library(DT) # For interactive html tables

# 3. Set default ggplot theme ----

theme_set(theme_graph())

# 4. Import data ----

# 4.2 Data benthos top 30 (raw) --

load("./../data/00_filtered/00-data_benthos-top_30.RData")

data_benthos <- data_benthos %>% 
  mutate(Longitude = st_coordinates(.)[,"X"],
         Latitude = st_coordinates(.)[,"Y"]) %>% 
  st_drop_geometry(.) 

```

# Table reef area by country

```{r}

# 1. Load data ----

load(file = "./../data/reefs.eez.RData")

# 2. Transform to an sf object ----

data_reefs <- reefs.eez %>% 
  st_as_sf()

# 3. Calculate the reef area by country ----

data_reefs <- data_reefs %>% 
  # Calculate the reef area and transform it from m2 to km2
  mutate(reef_area = as.numeric(st_area(.))/1000000) %>%
  # Make the sum of area by country
  st_drop_geometry() %>% 
  group_by(SOVEREIGN1) %>% 
  summarise(total_area_abs = sum(reef_area)) %>% 
  ungroup() %>% 
  # Sort rows from higher reef area to lower
  arrange(-total_area_abs) %>% 
  # Calculate the relative contribution
  mutate(total_area_rel = total_area_abs*100/sum(total_area_abs),
         pos = row_number()) %>% 
  # Misc. modifications for formattable
  select(pos, SOVEREIGN1, total_area_abs, total_area_rel) %>% 
  mutate(total_area_abs = round(as.numeric(total_area_abs), 3),
         total_area_rel = round(as.numeric(total_area_rel), 3))

# 4. Make the table ----

data_reefs %>% 
  formattable(.) %>% 
  as.datatable(., rownames = FALSE, colnames = c("N°", "Country", "Area (km²)", "Relative (%)"))

```

# Number of sites and observations

```{r}

# 1. Number of sites per country ----

nb_sites <- data_benthos %>% 
  select(SOVEREIGN1, Latitude, Longitude) %>% 
  distinct() %>% 
  group_by(SOVEREIGN1) %>% 
  summarise(n_sites = n())

# 2. Number of observations per country ----

nb_obs <- data_benthos %>% 
  group_by(SOVEREIGN1) %>% 
  summarise(n_obs = n()) %>% 
  ungroup() %>% 
  mutate(tot = sum(n_obs),
         n_rel = (n_obs*100)/tot) %>% 
  select(-tot)

```

# Distribution of years

```{r}

# 1. Modify the data ----

data_years2 <- data_benthos %>% 
  select(Latitude, Longitude, SOVEREIGN1, Year) %>% 
  distinct() %>% 
  group_by(SOVEREIGN1) %>% 
  mutate(total = n_distinct(Latitude, Longitude)) %>% 
  group_by(SOVEREIGN1, Year, total) %>% 
  summarise(n = n_distinct(Latitude, Longitude)) %>% 
  ungroup() %>% 
  mutate(freq = (n/total)*100)



data_years <- data_benthos %>% 
  select(Latitude, Longitude, Year, SOVEREIGN1) %>% 
  distinct(.) %>% 
  group_by(Year, SOVEREIGN1) %>% 
  count() %>% 
  group_by(SOVEREIGN1) %>% 
  mutate(Total = sum(n),
         freq = (n/sum(n))*100)

# 2. Make the loop ----

for (i in unique(data_years$SOVEREIGN1)) {
  
  data_years_i <- data_years %>% 
    filter(SOVEREIGN1 == i)
  
  plot_i <- ggplot(data_years_i, aes(x = Year, y = freq)) +
    geom_histogram(stat = "identity", color = col_color_graph, fill = col_fill_graph) +
    lims(x = c(1970, 2020)) +
    labs(x = "Year", y = "Percentage of sites") +
    labs(tag = "A") +
    theme(plot.tag = element_text(size = 20))
  
  ggsave(plot_i, filename = paste0("../figs/02_graph-transects-by-year_", tolower(as.character(i)), ".png"),
         width = 4,
         height = 4)
}

# 3. Verification

temp <- data_years %>% 
  filter(SOVEREIGN1 == "Maldives")

verif <- data_benthos %>% 
  filter(SOVEREIGN1 == "Maldives", Year == "2015") %>% 
  distinct(.)

```

# Methods used

```{r}

# 1. Modify the data ----

data_method <- data_benthos %>% 
  select(Latitude, Longitude, Year, Method, SOVEREIGN1) %>% 
  distinct(.) %>% 
  mutate(Method = str_split_fixed(Method, ",", 6)[,1],
         Method = str_to_lower(Method),
         Method = str_trim(Method, side = "both"),
         Method = str_squish(Method),
         Method = case_when(Method %in% c("line intercept transect", 
                                          "line intersect transect",
                                          "lit") ~ "LIT",
                            Method %in% c("point intercept method",
                                          "point intercept transect",
                                          "point intersect transect",
                                          "pit") ~ "PIT",
                            Method %in% c("photo-quadrat",
                                          "Photo-quadrat",
                                          "underwater photo transect") ~ "Photo-quadrat",
                            Method %in% c("visual census",
                                          "visual quadrat estimation",
                                          "vis est.") ~ "Visual census",
                            Method %in% c("chain intercept method",
                                          "cross intercept transect",
                                          "perpendicular intercept transect",
                                          "video-transect",
                                          "other") ~ "Other methods",
                            TRUE ~ "Unknown")) %>% 
  group_by(Method, SOVEREIGN1) %>% 
  count(name = "Abs") %>% 
  ungroup() %>% 
  complete(Method, SOVEREIGN1, fill = list(Abs = 0)) %>% 
  group_by(SOVEREIGN1) %>% 
  mutate(Rel = (Abs/sum(Abs))*100,
        Method = as.factor(Method)) %>% 
  ungroup() %>% 
  arrange(SOVEREIGN1)

# 2. Make the loop ----

for (i in unique(data_method$SOVEREIGN1)) {
  
  data_method_i <- data_method %>% 
    filter(SOVEREIGN1 == i)
  
  plot_i <- ggplot(data_method_i, aes(x = Method, y = Rel, label = paste0(round(Rel, 0), " %"))) +
    geom_bar(stat = "identity", col = "black", fill = col_fill_graph) +
    geom_text(hjust = -0.2) +
    coord_flip() +
    theme(axis.text = element_text(size = 12),
          axis.title = element_text(size = 16),
          plot.tag = element_text(size = 20)) +
    scale_x_discrete(name = NULL, 
                     limits = c("Unknown", "Other methods", "Visual census", "LIT", "PIT",  "Photo-quadrat")) +
    scale_y_continuous(name = "Percentage of sites", 
                       breaks = c(0, 25, 50, 75, 100), 
                       limits = c(0,110)) +
    labs(tag = "B")
  
  ggsave(plot_i, 
         filename = paste0("../figs/02_graph-transects-methods_", tolower(as.character(i)), ".png"),
         width = 6,
         height = 4)

}

```

# Methods used by time-range - %

```{r fig.width=15}

# 1. Modify the data ----

data_method <- data_benthos %>% 
  select(Latitude, Longitude, Year, Method, SOVEREIGN1) %>% 
  distinct(.) %>% 
  mutate(Method = str_split_fixed(Method, ",", 6)[,1],
         Method = str_to_lower(Method),
         Method = str_trim(Method, side = "both"),
         Method = str_squish(Method),
         Method = case_when(Method %in% c("line intercept transect", 
                                          "line intersect transect",
                                          "lit") ~ "LIT",
                            Method %in% c("point intercept method",
                                          "point intercept transect",
                                          "point intersect transect",
                                          "pit") ~ "PIT",
                            Method %in% c("photo-quadrat",
                                          "Photo-quadrat",
                                          "underwater photo transect") ~ "Photo-quadrat",
                            Method %in% c("visual census",
                                          "visual quadrat estimation",
                                          "vis est.") ~ "Visual census",
                            Method %in% c("chain intercept method",
                                          "cross intercept transect",
                                          "perpendicular intercept transect",
                                          "video-transect",
                                          "other") ~ "Other methods",
                            TRUE ~ "Unknown"),
         Time_range = case_when(Year >= 1970 & Year < 2000 ~ "1970-1999",
                                Year >= 2000 & Year < 2010 ~ "2000-2009",
                                Year >= 2010 & Year < 2020 ~ "2010-2019")) %>% 
  group_by(SOVEREIGN1, Method, Time_range) %>% 
  count(name = "Abs") %>% 
  drop_na(Time_range) %>% 
  ungroup() %>% 
  complete(SOVEREIGN1, Method, Time_range, fill = list(Abs = 0)) %>% 
  group_by(SOVEREIGN1) %>% 
  mutate(Rel = (Abs/sum(Abs))*100,
         Method = as.factor(Method)) %>% 
  ungroup() %>% 
  arrange(SOVEREIGN1)

# 2. Make the loop ----

for (i in unique(data_method$SOVEREIGN1)) {
  
  data_method_i <- data_method %>% 
    filter(SOVEREIGN1 == i)
  
  plot_i <- ggplot(data_method_i, aes(x = Time_range, y = Rel, fill = Method)) +
    geom_bar(stat = "identity", color = "black") +
    scale_fill_manual(values = col_method,
                      limits= c("Photo-quadrat", "PIT", "LIT", "Visual census", "Other methods", "Unknown")) +
    ylab("Percentage of sites") +
    labs(tag = "C") +
    theme(axis.title.x = element_blank(),
          plot.tag = element_text(size = 20))
          
    
  
  ggsave(plot_i, 
         filename = paste0("../figs/02_graph-transects-methods-by-time-range_", tolower(as.character(i)), ".png"),
         width = 6,
         height = 3)

}

```

# Table

```{r}

# 1. Export table of method by time-range for each country ----

data_method %>% 
  select(-Rel) %>% 
  pivot_wider(names_from = "Method", values_from = Abs) %>% 
  arrange(SOVEREIGN1, Time_range) %>% 
  group_by(SOVEREIGN1) %>% 
  do(write_csv2(., paste0("../figs/03_table-methods-used-by-time-range_", tolower(unique(.$SOVEREIGN1)), ".csv")))

```

# Taxonomic precision

```{r}

precision_taxo <- data_benthos %>% 
   select(SOVEREIGN1, Category, Group, Family, Genus, Species) %>% 
   mutate(Tax_lvl = case_when(!(is.na(Species)) ~ "Species",
                             !(is.na(Genus)) ~ "Genus",
                             !(is.na(Family)) ~ "Family",
                             !(is.na(Group)) ~ "Group",
                             !(is.na(Category)) ~ "Category")) %>%  
   select(-Category, -Group, -Family, -Genus, -Species) %>% 
   group_by(SOVEREIGN1, Tax_lvl) %>%
   summarise(Absolute = n()) %>% 
   ungroup(.) %>%
   group_by(SOVEREIGN1) %>% 
   mutate(Total = sum(Absolute),
         Percentage = (100*Absolute)/Total,
         Tax_lvl = as.factor(as.character(Tax_lvl)))

for (i in unique(data_benthos$SOVEREIGN1)) {

  precision_taxo_i <- precision_taxo %>% 
    filter(SOVEREIGN1 == i)
  
  plot_i <- ggplot() + # Plot
      geom_bar(data = precision_taxo_i, 
               aes(x = fct_rev(SOVEREIGN1), 
                   y = Percentage,
                   fill = fct_relevel(Tax_lvl, "Species", "Genus", "Family", "Group", "Category")),
               stat = "identity") +
      coord_flip() +
      scale_fill_manual(name = "Taxonomic level",
                      breaks = c("Category", "Group", "Family", "Genus", "Species"), 
                      values = c("#3fc380", "#5c97bf", "#fad859", "#eb9532", "#e74c3c"),
                      guide = guide_legend(title.position = "top"),
                      drop = FALSE) +
      scale_y_continuous(#name = element_blank(),
                         breaks = c(0, 25, 50, 75, 100),
                         labels= c("0 %", "25 %", "50 %", "75 %", "100 %"),
                         limits = c(0,100)) +
      labs(x = NULL,
           tag = "D") + 
      theme(plot.tag = element_text(size = 20),
          legend.position = "top",
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          panel.background = element_blank(),
          panel.border = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line.x.bottom =  element_line(colour = "black"))
    
  ggsave(plot_i, 
         filename = paste0("../figs/02_graph-transects-precision-taxo_", tolower(as.character(i)), ".png"),
         width = 5,
         height = 2)
}

## Save table 

write_csv2(precision_taxo, "../figs/02_percentage-precision-taxo.csv")

```

# Reproducibility

```{r reprod}

# 1. Reproducibility ----

sessionInfo()

```

---
Nina PRASIL & Jeremy WICQUART | `r format(Sys.time())`