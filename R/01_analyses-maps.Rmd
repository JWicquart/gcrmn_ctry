---
title: "Analyses - Maps"
author : "Nina Prasil & Jeremy Wicquart"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: "cosmo"
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 4
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.align = "center")

```

# 1. Import functions, packages and data

```{r base}

# 1. Source functions ----

source("functions/graphical_par.R")
source("functions/theme_map.R")

# 2. Required packages ----

library(tidyverse) # Core tidyverse packages
library(readxl) # To read excel files
library(sf) # To plot maps
library(ggspatial) # To plot maps
library(formattable) # For interactive html tables
library(DT) # For interactive html tables

# 3. Set default ggplot theme ----

theme_set(theme_map())

# 4. Define the CRS for the global map ----

crs_global <- "+proj=moll"

# 5. Import data ----

# 5.1 Data benthos top 30 (summarized, with time range) --

load("./../data/00_filtered/00-data_benthos-time_range_monitoring.RData")

# transform interval_class in levels

levels(data_benthos_range$interval_class)

# 5.2 Data benthos top 30 (raw) --

load("./../data/00_filtered/00-data_benthos-top_30.RData")

# 5.3 EEZ data --

data_eez <- read_sf("../data/01_maps/World_EEZ_v11_20191118/eez_v11.shp")

# 5.4 Background data map --
land_boundary <- read_sf("../data/01_maps/ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp")

land_major <- read_sf("../data/01_maps/ne_10m_land/ne_10m_land.shp") 

land_minor <- read_sf("../data/01_maps/ne_10m_minor_islands/ne_10m_minor_islands.shp") 
land_atolls <- read_sf("../data/01_maps/ne_10m_reefs/ne_10m_reefs.shp")

# 5.5 Create the background --

lats <- c(90:-90, -90:90, 90)
longs <- c(rep(c(180, -180), each = 181), 180)

world_map_background <- list(cbind(longs, lats)) %>%
  st_polygon() %>%
  st_sfc(crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% 
  st_sf() %>%
  st_transform(crs = crs_global)

# 5.6 Boundary data --

data_boundary <- read_xlsx("./../data/top_30_bbox.xlsx", sheet = 1)

# 5.7. Coral distribution data ----

coral_distribution <- read.csv("./../data/01_maps/02-clean_coral-distribution-reef-at-risk-data.csv") %>% 
  st_as_sf(., coords = c("long", "lat"))

# Add a CRS to the database (CRS = WGS84, ESPG = 4326)

st_crs(coral_distribution) <- 4326

ggplot() +
  geom_sf(data = coral_distribution)


```
# 1.2. MPAs
Need to merge all three files of points and do the same for the polygons to create a layer of points and one of polygons
```{r}

## MPAs from MPAtlas

data_mpa <- read_sf("./../data/02_mpa/mpatlas_20201223_clean/mpatlas_20201223_clean.shp") %>% 
  st_sfc(crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")

ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = coral_distribution, 
          color = "azure3", 
          size = rel(0.2), 
          alpha = 0.5,
          show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_boundary, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_mpa) +
  # Aesthetics
  theme(axis.title = element_blank())

# 5.8. MPAs from The protected planet database
info_mpa <- read.csv("./../data/02_mpa/WDPA_WDOECM_marine_csv/WDPA_WDOECM_marine_csv.csv")

data_mpa0 <- read_sf("./../data/WDPA_WDOECM_wdpa_shp0/WDPA_WDOECM_wdpa_shp-polygons.shp") %>% 
  filter(MARINE != 0)


```


# 2. Global maps

```{r}

# 1. Transform data to desired projection (Mollweide) ----

data_eez_trans <- data_eez %>% 
  st_transform(., crs = crs_global)

land_major_trans <- land_major %>% 
    st_transform(., crs = crs_global)

land_minor_trans <- land_minor %>% 
  st_transform(., crs = crs_global)

land_atolls_trans <- land_atolls %>% 
  st_transform(., crs = crs_global)

# 2. Create all the plots ----

results <- data_eez_trans %>%
  filter(SOVEREIGN1 %in% c("Belize", "Fiji", "France", "Egypt", "Maldives", "Indonesia")) %>% 
  group_by(SOVEREIGN1) %>%
  do(plot = ggplot() +
      geom_sf(data = world_map_background, fill = "#56B4E950", color = "grey30", size = 0.5/.pt) +
      geom_sf(data = land_major_trans, fill = col_fill_map, col = col_color_map) +
      geom_sf(data = ., col = col_eez_g, fill = col_eez_g, alpha = 0.7) +
      geom_sf(data = land_minor_trans, fill = col_fill_map, col = col_color_map) +
      geom_sf(data = land_atolls_trans, fill = col_fill_map, col = col_color_map) +
      theme(strip.background = element_rect(fill = "transparent", color = NA),
            plot.background = element_rect(fill = "transparent", color = NA),
            panel.grid = element_blank(),
            panel.background = element_blank()))

# 3. Export all the plots ----

for (i in 1:nrow(results)) {
  
  ggsave(cowplot::plot_grid(plotlist = results$plot[i]), 
         filename = paste0("../figs/01_global-map-by-country_", tolower(as.character(results[i, "SOVEREIGN1"])), ".png"))

}

```

# 3. Individual maps

# 3.1 Classic maps

```{r}

# 1. Create list of country to plot ----

list_classic <- data_boundary %>% 
  filter(plot_type == "classic") %>% 
  distinct(SOVEREIGN1) %>% 
  pull()

# 2. Make the loop ----

for (i in list_classic) {
  
  data_eez_i <- data_eez %>% 
    filter(SOVEREIGN1 == i)
  
  data_benthos_i <- data_benthos_range %>% 
    filter(SOVEREIGN1 == i)
  
  data_boundary_i <- data_boundary %>% 
    filter(SOVEREIGN1 == i)
  
  plot_i <- ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez_i, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = coral_distribution, 
             color = "azure3", size = rel(0.2), alpha = 0.5,
             show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_boundary, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_benthos_i, aes(col =  interval_class)) +
  # Define boundaries
  coord_sf(xlim = c(data_boundary_i$lon_min, data_boundary_i$lon_max), 
           ylim = c(data_boundary_i$lat_min, data_boundary_i$lat_max), expand = FALSE) +
  # Scalebar
  annotation_scale(location = "bl") +
  # Aesthetics
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  theme(axis.title = element_blank())
  

  ggsave(plot_i, filename = paste0("../figs/01_individual-map-by-country_", tolower(as.character(i)), ".png"))
  
}


  


```


# 3.2 Overlap maps
# 3.2.1 Overlap projection

```{r}

coral_distribution_ovlp <- coral_distribution %>%  
  mutate(long = ifelse(long < 0, long + 360, long))

data_eez_ovlp <- data_eez %>% 
  mutate(long = ifelse(long < 0, long + 360, long))
  
land_major_ovlp <- land_major %>% mutate(long = st_coordinates(.)[,"X"], 
       lat = st_coordinates(.)[,"Y"]) %>% 
  st_drop_geometry() %>%  mutate(long = ifelse(long < 0, long + 360, long))

land_minor_ovlp <- land_minor %>% mutate(long = ifelse(long < 0, long + 360, long))

data_boundary_ovlp <- data_boundary %>% mutate(long = ifelse(long < 0, long + 360, long))

land_atolls_ovlp <- land_atolls %>% mutate(long = ifelse(long < 0, long + 360, long))



```

# 3.2.2 Fiji

```{r}

# 1. Load data ----

# 1.1 EEZ data --

data_eez_fiji <- readOGR("../data/01_maps/World_EEZ_v11_20191118/eez_v11.shp", "eez_v11")

data_eez_fiji <- subset(data_eez_fiji, SOVEREIGN1 == "Fiji")

data_eez_fiji <- fortify(data_eez_fiji)

data_eez_fiji <- data_eez_fiji %>% 
  mutate(long = long + 360) %>% 
  bind_rows(data_eez_fiji, .)

# 1.2 Land major --

land_major_fiji <- readOGR("../data/01_maps/ne_10m_land/ne_10m_land.shp", "ne_10m_land") 

land_major_fiji <- fortify(land_major_fiji)

land_major_fiji <- land_major_fiji %>% 
  mutate(long = long + 360) %>% 
  bind_rows(land_major_fiji, .)

# 1.3 Land minor --

land_minor_fiji <- readOGR("../data/01_maps/ne_10m_minor_islands/ne_10m_minor_islands.shp", "ne_10m_minor_islands") 

land_minor_fiji <- fortify(land_minor_fiji)

land_minor_fiji <- land_minor_fiji %>% 
  mutate(long = long + 360) %>% 
  bind_rows(land_minor_fiji, .)

# 1.4 Land atolls --

land_atolls_fiji <- readOGR("../data/01_maps/ne_10m_reefs/ne_10m_reefs.shp", "ne_10m_reefs")

land_atolls_fiji <- fortify(land_atolls_fiji)

land_atolls_fiji <- land_atolls_fiji %>% 
  mutate(long = long + 360) %>% 
  bind_rows(land_atolls_fiji, .)

# 1.5 Data benthos range --

data_benthos_range_fiji <- data_benthos_range %>% 
  filter(SOVEREIGN1 == "Fiji") %>% 
  mutate(long = st_coordinates(.)[,"X"],
         lat = st_coordinates(.)[,"Y"]) %>% 
  st_drop_geometry() %>% 
  mutate(long = ifelse(long < 0, long + 360, long))

# 2. Make the plot ----

ggplot() +
  geom_polygon(data = data_eez_fiji2, aes(x = long, y = lat, group = group), fill = col_eez, alpha = 0.8) +
  geom_polygon(data = land_major_fiji, aes(x = long, y = lat, group = group), fill = col_fill_map, col = col_color_map) +
  geom_polygon(data = land_minor_fiji, aes(x = long, y = lat, group = group), fill = col_fill_map, col = col_color_map) +
  geom_polygon(data = land_atolls_fiji, aes(x = long, y = lat, group = group), fill = col_fill_map, col = col_color_map) +
  geom_point(data = data_benthos_range_fiji, aes(x = long, y = lat, col = interval_class)) +
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  scale_x_continuous(breaks = c(175, 180, 185), labels = c("175°E", "180°", "175°W"), limits = c(172, 185)) +
  scale_y_continuous(breaks = c(-25, -20, -15, -10), labels = c("25°S", "20°S", "15°S", "10°S"), limits = c(c(-26, -9))) +
  coord_quickmap()

# 3. Export the map ----

ggsave(filename = "../figs/01_individual-map-by-country_fiji.png")

# 4. Remove useless objects ----

rm(data_eez_fiji, land_major_fiji, land_minor_fiji, land_atolls_fiji, data_benthos_range_fiji)

# Another solution
# https://stackoverflow.com/questions/58662438/sf-ggplot-trying-to-map-fiji-islands

```






# 3.3 Composed maps

# 3.3.1 France

```{r}
#1. Data MPAs
## Select french MPAs with coral reefs

mpa_fr <- data_mpa %>% 
  st_drop_geometry() %>%
  filter(sovereign == "FRA") %>% 
  #distinct(country, .keep_all = T) %>% 
  filter(is_mpa==1) %>% 
  arrange(country)

amp_coral_fr <- data_mpa %>% 
  filter(country %in% c("BLM", "GLP", "MAF", "MTQ", "MYT", "NCL", "PYF", "REU", "BLM;GLP;MAF;MTQ"	)) %>% 
  arrange(country)



## Calculate the number and surface of MPAs in tropical waters


#france_area <- data_benthos %>% st_drop_geometry() %>% distinct(SOVEREIGN1, Location, .keep_all = T) %>%  filter(SOVEREIGN1 == "France") %>% arrange(Archipelago, Location)

data_eez_fr <- data_eez %>% 
    filter(SOVEREIGN1 == "France")
  
data_benthos_fr <- data_benthos_range %>% 
    filter(SOVEREIGN1 == "France")

# 2. Make the individual maps
# 2.1. French Antillas

data_boundary_i <- data_boundary %>% 
    filter(sub_country == "antilles_fr")
  
plot_i <- ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez_fr, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_point(data = coral_distribution, aes(x = long, y = lat),
             color = "azure3", size = rel(0.2), alpha = 0.5,
             show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_boundary, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_benthos_fr, aes(col =  interval_class)) +
  # Define boundaries
  coord_sf(xlim = c(data_boundary_i$lon_min, data_boundary_i$lon_max), 
           ylim = c(data_boundary_i$lat_min, data_boundary_i$lat_max), expand = FALSE) +
  # Scalebar
  annotation_scale(location = "bl") +
  # Aesthetics
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  theme(axis.title = element_blank()) +
  theme(legend.position = "none") +
  ggtitle("French Antillas")
  

ggsave(plot_i, filename = paste0("../figs/01_individual-map-for-france_french_antillas.png"))
  

# 2.2. New Caledonia

data_boundary_i <- data_boundary %>% 
    filter(sub_country == "new_caledonia")
  
plot_i <- ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez_fr, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_point(data = coral_distribution, aes(x = long, y = lat),
             color = "azure3", size = rel(0.2), alpha = 0.5,
             show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_boundary, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_benthos_fr, aes(col =  interval_class)) +
  # Define boundaries
  coord_sf(xlim = c(data_boundary_i$lon_min, data_boundary_i$lon_max), 
           ylim = c(data_boundary_i$lat_min, data_boundary_i$lat_max), expand = FALSE) +
  # Scalebar
  annotation_scale(location = "bl") +
  # Aesthetics
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  theme(axis.title = element_blank()) +
  theme(legend.position = "none") +
  ggtitle("New Caledonia")
  

ggsave(plot_i, filename = paste0("../figs/01_individual-map-for-france_new_caledonia.png"))

# 2.3. French Polynesia

data_boundary_i <- data_boundary %>% 
    filter(sub_country == "french_polynesia")
  
plot_i <- ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez_fr, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_point(data = coral_distribution, aes(x = long, y = lat),
             color = "azure3", size = rel(0.2), alpha = 0.5,
             show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_boundary, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_benthos_fr, aes(col =  interval_class)) +
  # Define boundaries
  coord_sf(xlim = c(data_boundary_i$lon_min, data_boundary_i$lon_max), 
           ylim = c(data_boundary_i$lat_min, data_boundary_i$lat_max), expand = FALSE) +
  # Scalebar
  annotation_scale(location = "bl") +
  # Aesthetics
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  theme(axis.title = element_blank()) +
  theme(legend.position = "none") +
  ggtitle("French Polynesia")
  

ggsave(plot_i, filename = paste0("../figs/01_individual-map-for-france_french_polynesia.png"))

# 2.4. Wallis and Futuna

data_boundary_i <- data_boundary %>% 
    filter(sub_country == "wallis_and_futuna")
  
plot_i <- ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez_fr, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_point(data = coral_distribution, aes(x = long, y = lat),
             color = "azure3", size = rel(0.2), alpha = 0.5,
             show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_boundary, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_benthos_fr, aes(col =  interval_class)) +
  # Define boundaries
  coord_sf(xlim = c(data_boundary_i$lon_min, data_boundary_i$lon_max), 
           ylim = c(data_boundary_i$lat_min, data_boundary_i$lat_max), expand = FALSE) +
  # Scalebar
  annotation_scale(location = "bl") +
  # Aesthetics
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  theme(axis.title = element_blank()) +
  theme(legend.position = "none") +
  ggtitle("Wallis and Futuna")
  

ggsave(plot_i, filename = paste0("../figs/01_individual-map-for-france_wallis_and_futuna.png"))

# 2.4. Clipperton

data_boundary_i <- data_boundary %>% 
    filter(sub_country == "clipperton")
  
plot_i <- ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez_fr, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_point(data = coral_distribution, aes(x = long, y = lat),
             color = "azure3", size = rel(0.2), alpha = 0.5,
             show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_benthos_fr, aes(col =  interval_class)) +
  # Define boundaries
  coord_sf(xlim = c(data_boundary_i$lon_min, data_boundary_i$lon_max), 
           ylim = c(data_boundary_i$lat_min, data_boundary_i$lat_max), expand = FALSE) +
  # Scalebar
  annotation_scale(location = "bl") +
  # Aesthetics
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  theme(axis.title = element_blank()) +
  theme(legend.position = "none") +
  ggtitle("Clipperton")
  

ggsave(plot_i, filename = paste0("../figs/01_individual-map-for-france_clipperton.png"))

# 2.5. Mascarene and Eparses Islands

data_boundary_i <- data_boundary %>% 
    filter(sub_country == "west_indian")
  
plot_i <- ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez_fr, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_point(data = coral_distribution, aes(x = long, y = lat),
             color = "azure3", size = rel(0.2), alpha = 0.5,
             show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_boundary, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_benthos_fr, aes(col =  interval_class)) +
  # Define boundaries
  coord_sf(xlim = c(data_boundary_i$lon_min, data_boundary_i$lon_max), 
           ylim = c(data_boundary_i$lat_min, data_boundary_i$lat_max), expand = FALSE) +
  # Scalebar
  annotation_scale(location = "bl") +
  # Aesthetics
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  theme(axis.title = element_blank()) +
  theme(legend.position = "none") +
  ggtitle("Eparses and Mascarene Islands")
  

ggsave(plot_i, filename = paste0("../figs/01_individual-map-for-france_west_indian.png"))

#2.6. Global map France
plot_i <- ggplot() +
  # Adding the EEZ
  geom_sf(data = data_eez_fr, fill = col_eez, color = col_eez_b, alpha = 0.8) +
  # Adding territories
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_point(data = coral_distribution, aes(x = long, y = lat),
             color = "azure3", size = rel(0.2), alpha = 0.5,
             show.legend = FALSE) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_boundary, fill = col_fill_map, col = col_color_map) +
  # Adding the location sites
  geom_sf(data = data_benthos_fr, aes(col =  interval_class)) +
  # Define boundaries
  coord_sf(ylim = c(-50,50), expand = FALSE) +
  # Scalebar
  annotation_scale(location = "bl") +
  # Aesthetics
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values = palette_trange, name = "Time range (years)", drop = FALSE) +
  theme(axis.title = element_blank()) 

ggsave(plot_i, filename = paste0("../figs/01_individual-map-for-france_global.png"))
```

# 3.3.2 USA

```{r}





```

# 3.3.3 UK

```{r}





```

# Reproducibility

```{r reprod}

# 1. Reproducibility ----

sessionInfo()

```

---
Nina PRASIL & Jeremy WICQUART | `r format(Sys.time())`