---
title: "Analyses - Maps"
author : "Nina Prasil & Jeremy Wicquart"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: "cosmo"
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 4
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.align = "center")

```

# Defining functions and packages

```{r base}

# 1. Source functions ----

source("functions/graphical_par.R")
source("functions/theme_graph.R")

# 2. Required packages ----

library(tidyverse) # Core tidyverse packages
library(sf) # To plot maps
library(formattable) # For interactive html tables
library(DT) # For interactive html tables

# 3. Set default ggplot theme ----

theme_set(theme_graph())

```

# Reef area by country

```{r}

# 1. Load data ----

load(file = "./../data/reefs.eez.Rdata")

# 2. Transform to an sf object ----

data_reefs <- reefs.eez %>% 
  st_as_sf()

# 3. Calculate the reef area by country ----

data_reefs <- data_reefs %>% 
  # Calculate the reef area and transform it from m2 to km2
  mutate(reef_area = as.numeric(st_area(.))/1000000) %>%
  # Make the sum of area by country
  st_drop_geometry() %>% 
  group_by(SOVEREIGN1) %>% 
  summarise(total_area_abs = sum(reef_area)) %>% 
  ungroup() %>% 
  # Sort rows from higher reef area to lower
  arrange(-total_area_abs) %>% 
  # Calculate the relative contribution
  mutate(total_area_rel = total_area_abs*100/sum(total_area_abs),
         pos = row_number()) %>% 
  # Misc. modifications for formattable
  select(pos, SOVEREIGN1, total_area_abs, total_area_rel) %>% 
  mutate(total_area_abs = round(as.numeric(total_area_abs), 3),
         total_area_rel = round(as.numeric(total_area_rel), 3))

# 4. Make the table ----

data_reefs %>% 
  formattable(.) %>% 
  as.datatable(., rownames = FALSE, colnames = c("N°", "Country", "Area (km²)", "Relative (%)"))

```

# Economic Exclusive Zone

```{r}

# 1. Load EEZ data ----

data_eez <- read_sf("../data/01_maps/World_EEZ_v11_20191118/eez_v11.shp") %>% 
  select(SOVEREIGN1)

# 2. Make the map ----

#ggplot() +
#  geom_sf(data = data_eez)

```

# Load top 30

```{r}

load("./../data/00_filtered/00-data_benthos-top_30.RData")

```

# Load summarized monitoring time range

```{r}

load("./../data/00_filtered/00-data_benthos-time_range_monitoring.RData")

```

# Retrieve the countries names for 4 countries

```{r}

# For Jeremy
data_benthos <- read.csv2("C:/Users/jwicquart/Desktop/Recherche/Projets/2019-07-08 - Global Coral Reef Monitoring Network/GCRMN_2020/data/03-merge_all_all_all_benthos_NA.csv") %>% 
  filter(!is.na(Latitude) & !is.na(Longitude) & !is.na(Year)) %>%
  group_by(Area, Country, Location, Site, Latitude, Longitude) %>% 
  summarise(interval_years = max(Year, na.rm = TRUE) - min(Year, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(interval_class = cut(interval_years, 
                              breaks = c(-Inf, 1, 5, 10, 20, Inf),
                              labels = c("1", "2-5", "6-10", "11-20", ">20")))

```

```{r}

# 1. Load data ----

load("./../data/00_filtered/00-data_benthos-top_30.RData")

# Extracts a limited amount of datasets
benthos_red <- data_benthos_30 %>% 
  filter(DatasetID %in% c("MART1", "MART2", "MART3", "MALD1", "VIRG1", "GUAD1")) 

#Converts the coordinates in the database in an sf object

benthos_red <- benthos_red %>% 
   st_as_sf(., coords = c("Longitude", "Latitude")) 

st_crs(benthos_red) <- 4326

# Joins the location sites to the EEZs 

benthos_red <- st_join(benthos_red,data_eez)

```

# Background maps and sites location - GLOBAL 30

```{r}

# 1. Load background map data ----

# 1.1 Major islands --

land_major <- read_sf("../data/01_maps/ne_10m_land/ne_10m_land.shp") %>%
  st_transform(., crs = "+proj=moll")

# 1.2 Minor islands --

land_minor <- read_sf("../data/01_maps/ne_10m_minor_islands/ne_10m_minor_islands.shp") %>%   st_transform(., crs = "+proj=moll")

# 1.3 Reefs and atolls --

land_atolls <- read_sf("../data/01_maps/ne_10m_reefs/ne_10m_reefs.shp") %>% 
  st_transform(., crs = "+proj=moll")



data_benthos_tRange <- data_benthos_tRange %>% 
  st_as_sf(., coords = c("Longitude", "Latitude"))

# Add a CRS to the database (CRS = GWS84, ESPG = 4326)
st_crs(data_benthos_tRange) <- 4326


data_benthos_tRange <- data_benthos_tRange %>% 
  st_transform(., crs = "+proj=moll")

# 2. Make the map ---- Using Mollweide projection

data_benthos_tRange %>%  
  ggplot() +
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = data_benthos_tRange, aes(col = interval_class)) +
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank())
             
             
  

ggsave("./../figs/01-map_site-location-global30_.png", width = 12, height = 6)

 

```

# Plot des Maldives 

```{r warning=FALSE}

# 1. Load background map data ----

# 1.1 Major islands --

land_major <- read_sf("../data/01_maps/ne_10m_land/ne_10m_land.shp")

# 1.2 Minor islands --

land_minor <- read_sf("../data/01_maps/ne_10m_minor_islands/ne_10m_minor_islands.shp")

# 1.3 Reefs and atolls --

land_atolls <- read_sf("../data/01_maps/ne_10m_reefs/ne_10m_reefs.shp")

# 2. Make the map ----
  
data_test <- data_eez %>% 
  filter(SOVEREIGN1 == "Maldives")

temp <- data_benthos_30 %>% 
  # Select the Maldives only
  filter(SOVEREIGN1 == "Maldives") 


# Create the map
ggplot() +
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  # Adding the EEZ
  geom_sf(data = data_test) +
  # Adding the location sites
  geom_sf(data = temp, aes(col = interval_class)) +
  xlab("Longitude") + ylab("Latitude") +
  #Focus on the Maldives
  coord_sf(xlim = c(65, 80), ylim = c(-5, 10), expand = FALSE) 
  
  
  # GLOBAL MAP - Maldives
  
data_test <- data_test %>% 
  st_transform(., crs = "+proj=moll")
  
  ggplot() +
  # Red EEZ
  geom_sf(data = data_test, col = "firebrick2", fill = "firebrick2", alpha = 0.7) +
  #Blue EEZ
  #geom_sf(data = data_test, col = "dodgerblue4", fill = "dodgerblue4", alpha = 0.7) +
  geom_sf(data = land_major, fill = "grey", col = "grey") +
  geom_sf(data = land_minor, fill = "grey", col = "grey") +
  geom_sf(data = land_atolls, fill = "grey", col = "grey") +
  # Theme elements
  theme(panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank())
        
  


```

#test Indonesia

```{r}
data_test <- data_eez %>% 
  filter(SOVEREIGN1 == "Indonesia")

data_benthos_30 %>% 
  # Select the Maldives only
  filter(SOVEREIGN1 == "Indonesia") %>% 
  # Create the map
  ggplot() +
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  # Adding the EEZ
  geom_sf(data = data_test) +
  # Adding the location sites
  geom_sf(col = "red") +
  xlab("Longitude") + ylab("Latitude") +
  #Focus on the Maldives
  coord_sf(xlim = c(90, 145), ylim = c(-15, 10), expand = FALSE)


# Plot EEZ MICRONESIA

data_eez %>% 
  filter(SOVEREIGN1 == "Tonga" )%>% 
  ggplot() +
  geom_sf() +
  coord_sf(xlim = c(155, 180), ylim = c(0, 20), expand = FALSE)

```


# Background maps and sites location - TOP 30

```{r}

# 1. Load background map data ----

# 1.1 Major islands --

land_major <- read_sf("../data/01_maps/ne_10m_land/ne_10m_land.shp")

# 1.2 Minor islands --

land_minor <- read_sf("../data/01_maps/ne_10m_minor_islands/ne_10m_minor_islands.shp")

# 1.3 Reefs and atolls --

land_atolls <- read_sf("../data/01_maps/ne_10m_reefs/ne_10m_reefs.shp")

# 2. Make the map ----

temp <- data_benthos_30 %>% 
  select(SOVEREIGN1, geometry) %>% 
  distinct(geometry, .keep_all = T)
  ggplot() +
  geom_sf(data = land_major, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_minor, fill = col_fill_map, col = col_color_map) +
  geom_sf(data = land_atolls, fill = col_fill_map, col = col_color_map) +
  geom_sf()
  
```

# Reproducibility

```{r reprod}

# 1. Reproducibility ----

sessionInfo()

```

---
Nina PRASIL & Jeremy WICQUART | `r format(Sys.time())`